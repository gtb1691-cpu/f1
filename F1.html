<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Token Economy â€“ Pista F1</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    padding: 20px;
  }

  h2 { text-align: center; margin-bottom: 20px; }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Pannello F1 in alto a sinistra â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #f1panel {
    position: fixed;
    top: 15px;
    left: 15px;
    background: black;
    color: white;
    padding: 12px 18px;
    border-left: 6px solid red;
    border-top: 3px solid red;
    border-bottom: 3px solid red;
    border-right: 3px solid red;
    border-radius: 6px;
    font-size: 18px;
    line-height: 1.4;
    z-index: 999;
    box-shadow: 0 0 8px rgba(0,0,0,0.5);
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Pista â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .track-wrapper {
    position: relative;
    width: 100%;
    height: 180px;
    overflow-x: auto;
    overflow-y: hidden;
    background: #222;
    border-radius: 50px;
    border: 3px solid #555;
    scroll-behavior: smooth;
    margin-top: 80px;
  }

  .track {
    position: relative;
    height: 180px;
    min-width: 2000px;
  }

  .car {
    position: absolute;
    top: 90px;
    left: 0;
    font-size: 60px;
    transition: left 0.8s ease-out;
    transform: scaleX(-1);
    z-index: 3;
  }

  .start-light {
    position: absolute;
    top: 20px;
    left: 40px;
    width: 40px;
    padding: 8px;
    background: black;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    box-shadow: 0 0 6px #000;
    z-index: 5;
  }

  .light {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background: #330000;
    transition: background 0.3s ease;
    border: 1px solid #222;
  }

  .light.red { background: red; }
  .light.green { background: #00aa00; }

  .checkpoint {
    position: absolute;
    top: 10px;
    font-size: 24px;
    color: white;
    text-align: center;
    transform: translateX(-50%);
  }

  input, button {
    font-size: 18px;
    padding: 6px 10px;
    margin: 5px;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Riquadro 5 giorni â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #dailyPanel {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 260px;
    background: black;
    color: white;
    padding: 15px;
    border: 4px solid white;
    border-image: repeating-linear-gradient(
      45deg,
      black 0 10px,
      white 10px 20px
    ) 6;
    border-radius: 10px;
    box-shadow: 0 0 6px rgba(0,0,0,0.6);
    z-index: 999;
  }

  #dailyPanel h3 {
    margin-top: 0;
    margin-bottom: 5px;
    font-size: 18px;
    text-align: center;
  }

  #dailyDate {
    font-size: 14px;
    margin-bottom: 10px;
    text-align: center;
  }

  #dailyTable td {
    padding: 2px 6px;
    font-size: 15px;
  }
</style>
</head>

<body>

<h2>ğŸï¸ Token Economy â€“ Pista di Formula 1</h2>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Pannello F1 sinistra â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="f1panel">
  <div id="panelTokens">TOKEN TOTALI: 0</div>
  <div id="panelTokensSpent">TOKEN SPESI: 0</div>
  <div id="panelBonus">BONUS DISPONIBILI: 0</div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Pista â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="track-wrapper" id="trackWrapper">
  <div class="track" id="track">
    <div id="trafficLight" class="start-light">
      <div class="light red" id="startLight"></div>
    </div>

    <div class="car" id="car">ğŸï¸</div>
  </div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Input e comandi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div style="text-align:center; margin-top:10px;">
  <input type="number" step="0.1" id="tokenAdd" placeholder="Aggiungi token">
  <button onclick="addTokens()">Aggiungi Token</button>

  <br>

  <input type="number" step="0.1" id="tokenSpent" placeholder="Token spesi">
  <button onclick="spendTokens()">Registra Token Spesi</button>

  <br><br>

  <input type="number" step="1" id="bonusSpent" placeholder="Bonus spesi">
  <button onclick="spendBonus()">Registra Bonus Speso</button>

  <br><br>

  <button style="background:#b30000; color:white;" onclick="undoLast()">âŸ² Annulla ultima operazione</button>
  <button style="background:#444; color:white;" onclick="resetAll()">RESET COMPLETO</button>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Riquadro 5 giorni sotto pista â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="dailyPanel">
  <h3>ğŸ Token ultimi 5 giorni</h3>
  <div id="dailyDate"></div>
  <table id="dailyTable">
    <tr><td>LunedÃ¬:</td><td id="d1">0</td></tr>
    <tr><td>MartedÃ¬:</td><td id="d2">0</td></tr>
    <tr><td>MercoledÃ¬:</td><td id="d3">0</td></tr>
    <tr><td>GiovedÃ¬:</td><td id="d4">0</td></tr>
    <tr><td>VenerdÃ¬:</td><td id="d5">0</td></tr>
  </table>
  <button onclick="skipDay()">â­ Salta giornata</button>
</div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Variabili principali â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let totalTokens = 0;
let lifetimeTokens = 0;
let spentTokens = 0;
let spentBonuses = 0;
let maxTokensEver = 0;
let historyStack = [];
const BONUS_EVERY = 50;

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Token giornalieri 5 giorni â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let dailyTokens = [0,0,0,0,0]; // Lunâ€“Ven
let currentDayIndex = 0;
let lastUpdateTimestamp = Date.now();

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateDailyDate() {
  const now = new Date();
  const d = now.toLocaleDateString("it-IT");
  document.getElementById("dailyDate").textContent = "Data: " + d;
}

function refreshDailyTable() {
  for (let i = 0; i < 5; i++) {
    document.getElementById("d" + (i+1)).textContent = dailyTokens[i];
  }
  updateDailyDate();
}

function skipDay() {
  currentDayIndex++;
  if (currentDayIndex > 4) currentDayIndex = 0;
  dailyTokens[currentDayIndex] = 0;
  refreshDailyTable();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Controllo cambio giornata alle 08:00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function checkDaySwitch() {
  const now = new Date();
  const last = new Date(lastUpdateTimestamp);

  if (now.getDate() !== last.getDate() && now.getHours() >= 8) {
    currentDayIndex++;
    if (currentDayIndex > 4) currentDayIndex = 0;
    dailyTokens[currentDayIndex] = 0;
    lastUpdateTimestamp = Date.now();
    refreshDailyTable();
  }
}
setInterval(checkDaySwitch, 60000);

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Gestione token / bonus â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function saveState() {
  historyStack.push({
    totalTokens, lifetimeTokens, spentTokens, spentBonuses,
    maxTokensEver, dailyTokens: JSON.stringify(dailyTokens)
  });
}

function undoLast() {
  if (historyStack.length === 0) return;
  const prev = historyStack.pop();
  totalTokens = prev.totalTokens;
  lifetimeTokens = prev.lifetimeTokens;
  spentTokens = prev.spentTokens;
  spentBonuses = prev.spentBonuses;
  maxTokensEver = prev.maxTokensEver;
  dailyTokens = JSON.parse(prev.dailyTokens);
  updateAll();
  refreshDailyTable();
}

function addTokens() {
  saveState();
  const val = parseFloat(document.getElementById("tokenAdd").value.replace(",", ".")) || 0;
  totalTokens += val;
  lifetimeTokens += val;
  dailyTokens[currentDayIndex] += val;
  if (dailyTokens[currentDayIndex] > 5) dailyTokens[currentDayIndex] = 5;
  document.getElementById("tokenAdd").value = "";
  refreshDailyTable();
  updateAll();
}

function spendTokens() {
  saveState();
  const val = parseFloat(document.getElementById("tokenSpent").value.replace(",", ".")) || 0;
  spentTokens += val;
  totalTokens -= val;
  if (totalTokens < 0) totalTokens = 0;
  document.getElementById("tokenSpent").value = "";
  updateAll();
}

function spendBonus() {
  saveState();
  const val = parseInt(document.getElementById("bonusSpent").value) || 0;
  spentBonuses += val;
  document.getElementById("bonusSpent").value = "";
  updateAll();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Pista / Checkpoint â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateAll() {
  const car = document.getElementById("car");
  const track = document.getElementById("track");
  const wrapper = document.getElementById("trackWrapper");

  if (totalTokens > maxTokensEver) maxTokensEver = totalTokens;
  let leftPos = maxTokensEver * 10;
  car.style.left = leftPos + "px";

  // Semaforo verde appena inseriti token
  const light = document.getElementById("startLight");
  if (lifetimeTokens > 0) {
    light.classList.remove("red");
    light.classList.add("green");
  }

  if (leftPos + 300 > track.offsetWidth) {
    track.style.minWidth = (leftPos + 600) + "px";
  }

  generateCheckpoints();
  wrapper.scrollLeft = Math.max(0, leftPos - wrapper.offsetWidth / 2);

  const totalBonusEarned = Math.floor(lifetimeTokens / BONUS_EVERY);
  const available = Math.max(0, totalBonusEarned - spentBonuses);

  document.getElementById("panelTokens").textContent =
    "TOKEN TOTALI: " + totalTokens.toString().replace(".", ",");
  document.getElementById("panelTokensSpent").textContent =
    "TOKEN SPESI: " + spentTokens.toString().replace(".", ",");
  document.getElementById("panelBonus").textContent =
    "BONUS DISPONIBILI: " + available;
  refreshDailyTable();
}

function generateCheckpoints() {
  const track = document.getElementById("track");
  track.querySelectorAll(".checkpoint").forEach(e => e.remove());
  const needed = Math.floor(maxTokensEver / BONUS_EVERY);
  for (let i = 1; i <= needed; i++) {
    const pos = i * BONUS_EVERY * 10;
    const cp = document.createElement("div");
    cp.className = "checkpoint";
    cp.style.left = pos + "px";
    cp.innerHTML = `ğŸâ­${i}<br>(${i * 50} pt)`;
    track.appendChild(cp);
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Reset completo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function resetAll() {
  totalTokens = 0;
  lifetimeTokens = 0;
  spentTokens = 0;
  spentBonuses = 0;
  maxTokensEver = 0;
  historyStack = [];
  dailyTokens = [0,0,0,0,0];
  currentDayIndex = 0;
  document.getElementById("car").style.left = "0px";

  const light = document.getElementById("startLight");
  light.classList.remove("green");
  light.classList.add("red");

  updateAll();
  refreshDailyTable();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Avvio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
refreshDailyTable();
updateAll();
</script>

</body>
</html>
